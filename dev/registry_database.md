# dsgrid Registry Database
The dsgrid registry is stored in a SQL database. It currently uses SQLite behind SQLAlchemy.
Support for a server solution (e.g., PostgreSQL) can easily be added when that becomes necessary.

This page describes the schema and some tips for developers on how to inspect it manually.

## Tables
Refer to the `create_tables` in `dsgrid/registry/registry_database.py` for the database schema.

### models
This table stores all project, dataset, dimension, and dimension mapping configurations.

- `id`: Generated by the database and uniquely identifies each row.
- `model_id`: Corresponds to `project_id`/`dataset_id`/`dimension_id`/`mapping_id`.
`project_id` and `dataset_id` values are created by users. dsgrid generates UUIDs for
`dimension_id` and `mapping_id`.
- `version`: dsgrid version of a model
- `model_type`: Specifies the type of the model in the row: `project`, `dataset`, `dimension`,
`dimension_mapping`.
- `registration_id`: Foreign key for the registration action that added the row.
- `model`: The dsgrid configuration, such as `ProjectConfigModel`, encoded as a JSON string.
Dimension and dimension mapping models contain their records.

**Note**: `model_id` + `version` + `model_type` is a secondary way to uniquely identify a row.

### key_value
This table contains metadata about the registry. It is a key/value store, and may be used for
other purposes in the future.

### registrations
This table contains records of all registration actions performed by users.

### current_versions
This table specifies the current version of each model. It contains one row for each unique
dsgrid model (`project_id`/`dataset_id`/`dimension_id`/`mapping_id`).

### contains
This table specifies parent-child relationships between models.

- A project "contains" datasets, dimensions, and mappings.
- A dataset "contains" dimensions and mappings.
- A dimension mapping "contains" dimensions.

## Inspect tables with the CLI utility sqlite3

**Note**: Please ensure that you have a recent version of sqlite3 (likely >= 3.42). The `model`
column in the `models` table contains a JSON-encoded string. Earlier versions do not support
JSON features. The version installed in macOS 13.7 (3.39.5) is insufficient. Mac users can
get a recent version with `homebrew` (`brew install sqlite3`). TODO Windows

### Open the database
```
$ sqlite3 -table dsgrid-test-data/filtered_registries/simple_standard_scenarios/registry.db
```
```
SQLite version 3.47.2 2024-12-07 20:39:59
Enter ".help" for usage hints.
sqlite> .tables
contains          key_value         registrations
current_versions  models
```

#### Look at who created the registry, when, and where the data resides
```
sqlite> SELECT * FROM key_value;
```
```
+------------+----------------------------------------------------------------+
|    key     |                             value                              |
+------------+----------------------------------------------------------------+
| created_by | dthom                                                          |
| created_on | 2024-12-17 16:30:56.118056                                     |
| data_path  | dsgrid-test-data/filtered_registries/simple_standard_scenarios |
+------------+----------------------------------------------------------------+
```

#### List unique projects
```
sqlite> SELECT DISTINCT model_id FROM models WHERE model_type = 'project';
```
```
+-------------------+
|     model_id      |
+-------------------+
| dsgrid_conus_2022 |
+-------------------+
```

#### List projects by version
```
sqlite> SELECT id, model_id, version FROM models WHERE model_type = 'project';
```
```
+-----+-------------------+---------+
| id  |     model_id      | version |
+-----+-------------------+---------+
| 51  | dsgrid_conus_2022 | 1.0.0   |
| 121 | dsgrid_conus_2022 | 1.1.0   |
| 156 | dsgrid_conus_2022 | 1.10.0  |
| 127 | dsgrid_conus_2022 | 1.2.0   |
| 131 | dsgrid_conus_2022 | 1.3.0   |
| 134 | dsgrid_conus_2022 | 1.4.0   |
| 137 | dsgrid_conus_2022 | 1.5.0   |
| 142 | dsgrid_conus_2022 | 1.6.0   |
| 145 | dsgrid_conus_2022 | 1.7.0   |
| 148 | dsgrid_conus_2022 | 1.8.0   |
| 152 | dsgrid_conus_2022 | 1.9.0   |
+-----+-------------------+---------+
```

#### List unique datasets
```
sqlite> SELECT DISTINCT model_id FROM models WHERE model_type = 'dataset';
```
```
+--------------------------------------------------------------+
|                           model_id                           |
+--------------------------------------------------------------+
| aeo2021_reference_commercial_energy_use_growth_factors       |
| aeo2021_reference_industrial_energy_use_growth_factors       |
| aeo2021_reference_other_commercial_energy_use_growth_factors |
| aeo2021_reference_residential_energy_use_growth_factors      |
| comstock_conus_2022_reference                                |
| dsgrid_efs_historical_2012_conus_load_shapes                 |
| eia_861_annual_energy_use_state_sector                       |
| resstock_conus_2022_reference                                |
| tempo_conus_2022                                             |
+--------------------------------------------------------------+
```

#### List dimensions of a specific type
```
sqlite> SELECT
    id,
    model_id,
    version,
    model->>'$.name' AS name,
    model->>'$.dimension_query_name' AS dimension_query_name
FROM models
WHERE
    model_type = 'dimension' AND
    model->>'$.type' = 'geography'
ORDER BY dimension_query_name;
```
```
+-----+--------------------------------------+---------+-----------------------------------+----------------------+
| id  |               model_id               | version |               name                | dimension_query_name |
+-----+--------------------------------------+---------+-----------------------------------+----------------------+
| 39  | 15a14d95-e1e3-47ff-9b4f-32fd3d42167f | 1.0.0   | all_dsgrid_conus_2022_geographies | all_geographies      |
| 31  | 93cfccef-e574-4e69-90b2-5cc93ec2a66f | 1.0.0   | US Census Divisions               | census_division      |
| 30  | 759ce37a-954c-4a17-9750-d240b0116ed8 | 1.0.0   | US Census Regions                 | census_region        |
| 71  | 55da1339-fdb7-49c2-bc50-5fce3f2929f8 | 1.0.0   | contiguous-United-States          | conus                |
| 33  | 60591df8-abdd-40dd-ace2-769c488779ca | 1.0.0   | Contiguous United States          | conus                |
| 1   | 15647b6e-84b7-4a10-8a3b-35a21d77b062 | 1.0.0   | US Counties 2020 L48              | county               |
| 105 | 17c67737-db30-4823-b114-6b5562422f89 | 1.0.0   | conus_2022-comstock_US_county_FIP | county               |
| 52  | 4e6a7bd8-8c3a-49b3-895c-1d45a93e5668 | 1.0.0   | ACS County 2018                   | county               |
| 112 | 885189fa-3c81-471f-96f2-b30fc4c9b781 | 1.0.0   | conus_2022-resstock_US_county_FIP | county               |
| 32  | dd965abb-8c2f-46ed-b3ac-d362a62edf07 | 1.0.0   | ReEDS PCA                         | reeds_pca            |
| 100 | 014fdd21-af12-4698-be60-f1e503a54d74 | 1.0.0   | states                            | state                |
| 79  | 6366a035-9aa1-4fcf-95db-c54a1bb7249e | 1.0.0   | US States                         | state                |
| 29  | c5e76cb6-4537-4f17-9db9-1e7eeda55eb9 | 1.0.0   | US States L48                     | state                |
| 96  | 008d8894-3957-45a3-8a30-3acb868b08dd | 1.0.0   | states                            | states               |
| 88  | 47c29315-7c74-4b51-a676-fbe478d52f61 | 1.0.0   | states                            | states               |
+-----+--------------------------------------+---------+-----------------------------------+----------------------+
```

### Dump the records for a specific dimension
This example uses the `id` value as displayed above, which uniquely identifies a row in the
`models` table.

```
$ sqlite3 dsgrid-test-data/filtered_registries/simple_standard_scenarios/registry.db "SELECT model->>'$.records' FROM models WHERE id = 1"
```
```
[{"id":"06037","name":"Los Angeles","time_zone":"PacificPrevailing","state":"CA"},{"id":"06073","name":"San Diego","time_zone":"PacificPrevailing","state":"CA"},{"id":"36047","name":"Kings","time_zone":"EasternPrevailing","state":"NY"},{"id":"36081","name":"Queens","time_zone":"EasternPrevailing","state":"NY"}]
```

If you are on a UNIX (e.g., Mac or Linux) and have [jq](https://jqlang.github.io/jq/) installed,
this command will pretty-print the output (or allow you to filter/transform the output):

```
sqlite3 dsgrid-test-data/filtered_registries/simple_standard_scenarios/registry.db \
    "SELECT model->>'$.records' FROM models WHERE id = 1;" | jq .
```
```
[
  {
    "id": "06037",
    "name": "Los Angeles",
    "time_zone": "PacificPrevailing",
    "state": "CA"
  },
  {
    "id": "06073",
    "name": "San Diego",
    "time_zone": "PacificPrevailing",
    "state": "CA"
  },
  {
    "id": "36047",
    "name": "Kings",
    "time_zone": "EasternPrevailing",
    "state": "NY"
  },
  {
    "id": "36081",
    "name": "Queens",
    "time_zone": "EasternPrevailing",
    "state": "NY"
  }
]
```

#### Manually update a model
There are cases where you may need to manually update a project/dataset/dimension/mapping model in
the database.

You will likely want to do this type of operation in Python. This example assumes that you are
running in a virtual environment where dsgrid has been installed (`sqlalchemy` is available).

This example also assumes that you have identified the database ID of the model you want to
update. In this case we will update the county dimension records.

```python
import json
from rich import print

from sqlalchemy import MetaData, Table, create_engine, insert, update, select, text

engine = create_engine("sqlite:///dsgrid-test-data/filtered_registries/simple_standard_scenarios/registry.db")
metadata = MetaData()
metadata.reflect(engine)
table = Table("models", metadata)
with engine.connect() as conn:
    stmt = select(table.c.model).where(table.c.id == 1)
    dimension = conn.execute(stmt).fetchone()[0]
    print(dimension["records"])
```
```
[
    {'id': '06037', 'name': 'Los Angeles', 'time_zone': 'PacificPrevailing', 'state': 'CA'},
    {'id': '06073', 'name': 'San Diego', 'time_zone': 'PacificPrevailing', 'state': 'CA'},
    {'id': '36047', 'name': 'Kings', 'time_zone': 'EasternPrevailing', 'state': 'NY'},
    {'id': '36081', 'name': 'Queens', 'time_zone': 'EasternPrevailing', 'state': 'NY'}
]
```

This removes the last record, as an example.
```
dimension["records"] = dimension["records"][:-1]
```
with engine.connect() as conn:
    stmt = (
        update(table)
        .where(table.c.id == 1)
        .values(model=dimension)
    )
    conn.execute(stmt)
    conn.commit()
```
